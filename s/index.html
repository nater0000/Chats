<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Submit GPT Log Entry</title>
  <link rel="icon" type="image/png" href="/assets/img/favicon.png">
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 700px;
      margin: 2em auto;
      padding: 1em;
      background: #111;
      color: #b5e853;
    }
    a.back-link {
      display: inline-block;
      margin-bottom: 1.5em;
      color: #b5e853;
      text-decoration: none;
      font-weight: bold;
    }
    label {
      display: block;
      margin-top: 1.5em;
    }
    textarea, input, select {
      width: 100%;
      background: #1c1c1c;
      color: #b5e853;
      border: 1px solid #444;
      padding: 0.6em;
      font-family: monospace;
      margin-top: 0.3em;
    }
    button {
      margin-top: 1.5em;
      padding: 0.75em 1em;
      width: 100%;
      background: #b5e853;
      color: #111;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #d7f98a;
    }
    small { display: block; color: #888; margin-bottom: 1em; }
    .block {
      margin-bottom: 1.5em;
      border: 1px solid #333;
      padding: 1em;
      border-radius: 6px;
    }
    #previewBox {
      background: #000;
      border: 1px solid #333;
      padding: 1em;
      margin-top: 2em;
      white-space: pre-wrap;
      font-family: monospace;
      display: none;
    }
    #filenameWarning {
      color: #ff6565;
      margin-top: 0.5em;
      font-size: 0.9em;
      display: none;
    }
  </style>
</head>
<body>
  <a href="/" class="back-link">‚Üê Back to Home</a>
  <h1>üìù New GPT Log Entry</h1>
  <form id="logForm">
    <label>GitHub Token (not saved)<small>Must have repo content write access</small></label>
    <input type="password" id="token" required>

    <input type="text" id="repo" value="nater0000/Chats" readonly hidden>

    <label>File Folder Path</label>
    <select id="path" required>
      <option value="pages" selected>pages</option>
      <option value="_gpts">_gpts</option>
    </select>

    <label>Entry Title</label>
    <input type="text" id="title" required>

    <label>Custom Page Name (optional)</label>
    <input type="text" id="customPage" oninput="checkFilenameCollision()">
    <div id="filenameWarning">‚ö†Ô∏è File with this name may already exist.</div>

    <label>Author</label>
    <input type="text" id="author" value="Nathan R" required>

    <label>Location</label>
    <input type="text" id="location" value="">

    <label>Terminal</label>
    <input type="text" id="terminal" value="">

    <label>GPT Model</label>
    <input type="text" id="gpt" value="">

    <label>Tags (comma separated)</label>
    <input type="text" id="tags" value="gpt">

    <label>Reference URL(s)</label>
    <div id="referenceInputs">
      <input type="text" class="reference" placeholder="https://example.com">
    </div>
    <button type="button" onclick="addReference()">‚ûï Add Another Reference</button>

    <div id="promptBlocks">
      <div class="block">
        <label>Prompt 1</label>
        <textarea class="prompt" rows="4"></textarea>
        <label>Response 1</label>
        <textarea class="response" rows="4"></textarea>
      </div>
    </div>

    <button type="button" onclick="addBlock()">‚ûï Add Prompt/Response</button>
    <button type="button" onclick="generatePreview()">üëÅÔ∏è Preview Before Submit</button>
    <button type="submit" style="display:none;" id="confirmSubmit">‚úÖ Confirm & Submit</button>
  </form>

  <pre id="previewBox"></pre>

  <script>
    function addBlock() {
      const container = document.getElementById('promptBlocks');
      const count = container.querySelectorAll('.block').length + 1;
      const div = document.createElement('div');
      div.className = 'block';
      div.innerHTML = `
        <label>Prompt ${count}</label>
        <textarea class="prompt" rows="4"></textarea>
        <label>Response ${count}</label>
        <textarea class="response" rows="4"></textarea>
      `;
      container.appendChild(div);
    }

    function addReference() {
      const container = document.getElementById('referenceInputs');
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'reference';
      input.placeholder = 'https://example.com';
      container.appendChild(input);
    }

    function slugifyFilename(text) {
      return text.toLowerCase().replace(/[^a-z0-9\-]+/g, '-').replace(/^-+|-+$/g, '') + '.md';
    }

    async function checkFilenameCollision() {
      const repo = document.getElementById('repo').value.trim();
      const path = document.getElementById('path').value.trim();
      const input = document.getElementById('customPage').value.trim();
      const warn = document.getElementById('filenameWarning');
      if (!input) return warn.style.display = 'none';
      const filename = slugifyFilename(input);
      const url = `https://api.github.com/repos/${repo}/contents/${path}/${filename}`;
      try {
        const res = await fetch(url);
        if (res.status === 200) {
          warn.style.display = 'block';
        } else {
          warn.style.display = 'none';
        }
      } catch {
        warn.style.display = 'none';
      }
    }

    function generateContent() {
      const title = document.getElementById('title').value.trim();
      const author = document.getElementById('author').value.trim();
      const location = document.getElementById('location').value.trim();
      const terminal = document.getElementById('terminal').value.trim();
      const gpt = document.getElementById('gpt').value.trim();
      const tags = document.getElementById('tags').value.trim();
      const customPage = document.getElementById('customPage').value.trim();

      const references = Array.from(document.querySelectorAll('.reference'))
        .map(input => input.value.trim())
        .filter(val => val.length > 0)
        .map(url => `  - ${url}`)
        .join('\n');

      const now = new Date();
      const date = now.toISOString().split('T')[0];
      const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      let logBlocks = '';
      const prompts = document.querySelectorAll('.prompt');
      const responses = document.querySelectorAll('.response');

      for (let i = 0; i < prompts.length; i++) {
        logBlocks += `\n<p class="terminal-line matrix user">user@local:~$</p>\n\n${prompts[i].value}\n\n<p class="terminal-line matrix gpt">gpt@remote:~$</p>\n\n${responses[i].value}\n\n---\n`;
      }

      let filename = customPage ? slugifyFilename(customPage) : `${date}-${title.toLowerCase().replace(/\s+/g, '-')}.md`;

      return {
        filename,
        content: `---\ntitle: ${title}\nauthor: ${author}\ndate: ${date}\ntime: ${time}\nlocation: ${location}\nterminal: ${terminal}\ngpt: ${gpt}\ntags: [${tags}]\nreferences:\n${references || '  -'}\nlayout: gpt-log\n---\n${logBlocks}`
      };
    }

    function generatePreview() {
      const previewData = generateContent();
      document.getElementById('previewBox').textContent = previewData.content;
      document.getElementById('previewBox').style.display = 'block';
      document.getElementById('confirmSubmit').style.display = 'inline-block';
    }

    document.getElementById('logForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const token = document.getElementById('token').value.trim();
      const repo = document.getElementById('repo').value.trim();
      const path = document.getElementById('path').value.trim();

      const { filename, content } = generateContent();

      const payload = {
        message: `Add new GPT log: ${filename}`,
        content: btoa(unescape(encodeURIComponent(content)))
      };

      const apiUrl = `https://api.github.com/repos/${repo}/contents/${path}/${filename}`;

      const responseGitHub = await fetch(apiUrl, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      if (responseGitHub.ok) {
        alert('‚úÖ Log entry submitted successfully!');
        document.getElementById('logForm').reset();
        document.getElementById('promptBlocks').innerHTML = '<div class="block"><label>Prompt 1</label><textarea class="prompt" rows="4"></textarea><label>Response 1</label><textarea class="response" rows="4"></textarea></div>';
        document.getElementById('referenceInputs').innerHTML = '<input type="text" class="reference" placeholder="https://example.com">';
        document.getElementById('previewBox').style.display = 'none';
        document.getElementById('confirmSubmit').style.display = 'none';
        document.getElementById('filenameWarning').style.display = 'none';
      } else {
        const error = await responseGitHub.json();
        alert('‚ùå Error: ' + error.message);
      }
    });
  </script>
</body>
</html>
